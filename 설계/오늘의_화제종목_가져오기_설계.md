## 미국 주식 “오늘의 화제 종목” 가져오기 설계

목표: 매일(한국 아침) “오늘의 화제 종목(Top 1)”을 **입력 없이 자동(Chatless)** 선정하기 위해, 데이터 소스 비교 → 권장 소스 선정 → 수집 코드 → 선정 로직 → 엣지 케이스 처리를 정의한다.

---

## 1) 데이터 소스별 장단점 비교

### 1-1. `yahooquery` Screener (Yahoo Finance 스크리너)

- **장점**
  - **객관 지표 기반**: 거래량(Volume), 상승률(% Change), 하락률 등 시장 데이터 중심
  - **구현 난이도 낮음**: Python 라이브러리로 빠르게 MVP 구현 가능
  - **커버리지 넓음**: 미국 상장 종목 전반을 포괄
  - **Chatless에 적합**: 사용자 입력(관심종목 설정) 없이도 “화제성”을 데이터로 정의 가능
- **단점**
  - **비공식/제3자 의존**: Yahoo Finance 데이터/엔드포인트 정책 변화 시 영향
  - **필드 품질/결측 가능**: 일부 종목에서 `regularMarketChangePercent` 등 핵심 필드 누락 가능
  - **시장 시간/휴장 영향**: 장외/휴장일에는 “당일” 지표가 기대와 다르게 보일 수 있음

### 1-2. ApeWisdom (WSB 24시간 멘션 순위)

- **장점**
  - **소셜 트렌드 반영**: 실제 커뮤니티 관심(언급량) 기반 “화제성”에 강함
  - **이슈 조기 감지**: 가격 반응 이전에 밈/이슈 종목을 포착할 가능성
- **단점**
  - **신뢰도/노이즈**: 밈/선동/봇 등의 영향, 투자 관점에서는 정보 품질 편차 큼
  - **정책/제공 형태 변경 위험**: 크롤링/비공식 API 의존 시 안정성 낮음
  - **시장 지표 부재**: “가격/거래량 기반 화제”와는 정의가 다름

### 1-3. SwaggyStocks (WSB 실시간 감성 분석)

- **장점**
  - **감성 정보 제공**: 긍·부정/멘션 추세 등 보조 인사이트 가능
  - **콘텐츠 확장**: “왜 화제인가?”를 감성 요약으로 보강 가능
- **단점**
  - **모델/데이터 편향**: 감성 분석 오차 및 커뮤니티 편향 존재
  - **외부 서비스 의존**: 가용성/요금/정책 변경 리스크
  - **MVP 범위 과대**: 핵심 목표(거래 활발 종목 자동 선정) 대비 복잡도 증가

---

## 2) 권장 데이터 소스 선정 및 근거

### 결론: **1차(필수) = `yahooquery` Screener**, 2차(선택) = ApeWisdom/SwaggyStocks “참고 지표”

- **핵심 근거**
  - 서비스 차별점이 “**가장 활발한 종목 자동 선정**”이므로, **거래량/변동률 같은 시장 데이터가 1순위**다.
  - WSB 기반 서비스는 “화제성”은 강하지만, **투자자(직장인)에게는 노이즈가 커서** MVP의 핵심 지표로 쓰기 위험하다.
  - 따라서 **선정(Top 1)은 Yahoo Finance 기반**, 소셜 데이터는 “추가 코멘트(참고)”로 점진 도입이 가장 안전하다.

---

## 3) `yahooquery` Screener 사용 코드 예시

아래 예시는 `yahooquery`의 Screener에서 `most_actives`, `day_gainers`, `day_losers`를 가져오는 최소 코드이다.

```python
from yahooquery import Screener

s = Screener()

most_actives = s.get_screeners("most_actives", count=10)
day_gainers = s.get_screeners("day_gainers", count=10)
day_losers = s.get_screeners("day_losers", count=10)

most_actives_quotes = most_actives["most_actives"]["quotes"]
day_gainers_quotes = day_gainers["day_gainers"]["quotes"]
day_losers_quotes = day_losers["day_losers"]["quotes"]

print("most_actives sample:", most_actives_quotes[0].get("symbol"), most_actives_quotes[0].get("shortName"))
```

권장: 실제 운영에서는 `try/except`, 타임아웃, 재시도, 응답 스키마 방어 코드(키 존재 여부)를 반드시 추가한다.

---

## 4) TOP 1 종목 선정 로직 (권장)

### 4-1. 후보군 구성

- `most_actives` 상위 N (기본 10)
- `day_gainers` 상위 M (기본 10)
- `day_losers` 상위 K (기본 10)

### 4-2. 점수화(Scoring) 방식 (추천)

단일 리스트 1등을 그대로 쓰면 “극단값/스파이크/결측”에 취약하므로, 3개 리스트를 합쳐 점수화한다.

- **기본 아이디어**
  - 거래량 상위에 있으면 가산점
  - 당일 급등/급락 상위에 있으면 가산점 (단, 급락은 별도 카테고리로 분리 가능)
  - 결측 필드가 많으면 감점 또는 제외

예: 아래는 간단한 가중치 예시(운영 중 A/B로 조정)

```python
def rank_score(rank: int) -> float:
    # 1등=1.0, 10등=0.1
    return max(0.0, (11 - rank) / 10)

WEIGHTS = {
    "most_actives": 0.55,
    "day_gainers": 0.30,
    "day_losers": 0.15,  # “화제”를 넓게 정의할 경우 포함
}
```

### 4-3. TOP 1 결정 규칙

1. 세 리스트를 합친 후보군에서 `symbol` 기준으로 중복 제거
2. 각 후보의 점수 = (리스트별 랭크점수 × 가중치) 합
3. **동점이면** 아래 순서로 타이브레이크
   - (1) `most_actives` 랭크가 더 높은 종목
   - (2) `regularMarketChangePercent` 절대값이 큰 종목(변동성)
   - (3) `regularMarketVolume`가 큰 종목
4. 최종 1개를 “오늘의 화제 종목”으로 선택

---

## 5) 엣지 케이스 처리

### 5-1. 데이터 없음 / 키 누락 / 빈 배열

- **상황**
  - `get_screeners()` 호출 실패(네트워크/차단)
  - `quotes` 키 없음
  - `quotes`는 있으나 길이가 0
- **처리**
  - 1차: 재시도(예: 2회, 지수 백오프)
  - 2차: 다른 리스트로 폴백 (`most_actives` → `day_gainers`)
  - 3차: “오늘은 데이터가 부족합니다” 메시지 + 전일 캐시 사용(권장)

### 5-2. 중복 종목

- **상황**: `most_actives`와 `day_gainers`에 동일 종목이 등장
- **처리**: `symbol` 기준으로 하나로 병합하되, **각 리스트에서의 최고 점수**를 모두 반영(합산)

### 5-3. ETF/레버리지/OTC 등 제외 규칙(선택)

- **상황**: 화제 종목이 ETF(예: TQQQ)일 수 있음
- **처리 옵션**
  - MVP: 허용(정보 제공 중심)
  - 고도화: `quoteType`/`typeDisp` 기반으로 “EQUITY만” 필터

### 5-4. 장외/휴장일(주말/공휴일)

- **상황**: “당일 상승률”이 의미 없거나 전일 데이터로 보일 수 있음
- **처리**
  - 미국 거래일 캘린더(예: NYSE)로 휴장 여부 판단
  - 휴장일에는 “최근 거래일 기준 화제 종목”으로 명시

### 5-5. 심볼 변경/정지/거래 중단 등

- **상황**: 종목이 일시 정지되었거나 심볼이 바뀐 경우
- **처리**
  - 선정 직후 `symbol`로 추가 조회(가격/뉴스 수집) 시 실패하면 다음 후보로 롤백
  - 실패 이벤트 로깅 및 블랙리스트/쿨다운 적용(예: 24시간 제외)

---

## 운영 체크리스트 (요약)

- **캐시**: 전일 Top 1, 후보 리스트, 점수 로그 저장(재현 가능성)
- **관측성**: 선정 근거(랭크/점수/필드)를 메타데이터로 남겨 브리핑에 “왜 화제인가” 한 줄 생성에 재사용
- **안정성**: 타임아웃/재시도/폴백/휴장 처리 필수


